{% extends "layout.html" %}
{% load static %}

{% block dbody %}

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="dynamic-body">
    <center>
        <table class="table table-striped table-bordered mydatatable" style="width: 60%">		
            {% for coin in fav_coins %}
            <tr>
                <td>
                    {% with 'radarcxapp/img/coins/'|add:coin.name|lower|add:'.png' as image_static %}
                    <img src="{% static image_static %}"  class="responsive"><span style="font-size: small !important; color: white">  {{coin.name}}</span>
                    {% endwith %}
                </td>
                <td>
                    <span id="{{ coin.name|add:'-USD' }}" style="font-size: small !important; color: white"></span>
                </td>
                <td>
                    <span id="{{ coin.name|add:'-USD-old'}}" style="font-size: small !important; color: white"></span>
                </td>
                <td id="{{ coin.name|add:'-USD-pstat'}}">
                    <img src="" id="{{ coin.name|add:'-USD-stat'}}" class="responsive">
                </td>
            </tr>
			{% endfor %}
		
            {% if user.is_authenticated %}
			{% if all_coins %}
				<form action="/add_coin" method="POST">{% csrf_token %}
					<select id="coin" name="coin" style="height: 20px; width: 60px">

						{% for coin in all_coins %}
						<option value="{{ coin|first }}">{{ coin|first }}</option>
						{% endfor %}
					</select>
					<input class="submit" type="submit" id="submit" value="Add coin to the list" style="height: 20px; width: 150px">
				</form>
			{% endif %}
			<br>
			{% if fav_coins %}
				<form action="/delete_coin" method="POST">{% csrf_token %}
					<select id="coin" name="coin"  style="height: 20px; width: 60px">
						
						{% for coin in fav_coins %}
						<option value="{{ coin.name }}">{{ coin.name }}</option>
						{% endfor %}
					
					</select>
					<input class="submit" type="submit" id="submit" value="Delete coin from the list"  style="height: 20px; width: 150px">
				</form>
			{% endif %}
		
			{% endif %}
        
        </table>
    </center>
</div>

<script>
    {% for coin in fav_coins %}setInterval(getCoin, 2000, "{{ coin.name }}", "USD");{% endfor %}
    async function getCoin(coin1, coin2) {
        const api_url = 'https://min-api.cryptocompare.com/data/price?fsym=' + coin1 + '&tsyms=' + coin2
        const response = await fetch(api_url);
        const data = await response.json();
        const {
            USD
        } = data;
        var newPrice = USD;
        var oldPrice = document.getElementById(coin1 + '-' + coin2).textContent;
        document.getElementById(coin1 + '-' + coin2 + '-old').textContent = oldPrice;
        document.getElementById(coin1 + '-' + coin2).textContent = newPrice;
        var imgdiff = document.createElement("img");

        if (newPrice > oldPrice) {
            imgdiff.src = "{% static 'radarcxapp/img/diff/gain.png' %}";
        } else if (newPrice < oldPrice) {
            imgdiff.src = "{% static 'radarcxapp/img/diff/loss.png' %}";
        } else {
            imgdiff.src = "{% static 'radarcxapp/img/diff/court.png' %}";
        }
        imgdiff.setAttribute("id", coin1 + '-' + coin2 + '-stat')
        imgdiff.setAttribute("width", "30")
        imgdiff.setAttribute("height", "30")
        var parent = document.getElementById(coin1 + '-' + coin2 + '-pstat');
        parent.replaceChild(imgdiff, parent.childNodes[1]);
    }
</script>
{% endblock %}